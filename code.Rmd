---
output:
  pdf_document:
    fig_caption: yes
    number_sections: no
   # toc: true
#bibliography: library.bib
---

```{r setup, include=FALSE}
library(plm)
library(RCurl)
library(dplyr)
library(plyr)
library(emibase)
library(plotrix)
library(mgcv)
library(reshape2)
library(readxl)
source('functions.R')
```

\vskip 20pt
\centerline{\bf \large VILNIUS UNIVERSITY}
\bigskip
\centerline{\large \textbf{FACULTY OF MATHEMATICS AND INFORMATICS}}
\vskip 120pt
\centerline{\bf \Large \textbf{BACHELOR THESIS}}
\vskip 50pt
\begin{center}
{\bf \LARGE Global terrorism and the economy}

\vspace{4mm}

\end{center}
\vskip 120pt
\centerline{\Large Eligijus Bujokas}
\vskip 120pt
\centerline{\large \textbf{VILNIUS (2016.12.07)}}

\newpage

\tableofcontents

\newpage

```{r constants, include=FALSE}
years.to.survey <- 1970:2015
regions <- read.csv(file="input/regions.csv", stringsAsFactors = F)
createdir("plots")
createdir("input")
createdir("data")
createdir("output")
devtools::install_url("http://cran.r-project.org/src/contrib/rprojroot_1.2.tar.gz") ## MAY RESOLVE TROUBLESHOOTS
```

```{r data download and reading it, include=FALSE, echo=F}
# we will save this data to the 'data' folder
download.terror(years.to.survey, "data/") 
dt <- read.terror("data/terror/")
dt <- arrange(dt, Date)
na.index <- which(apply(dt, 1, function(x){ all(is.na(x)) }))
if(length(na.index)!=0) dt <- dt[-na.index, ]
write.csv(dt, file="output/terror raw data.csv", na="", row.names=F)

## Tourism data

dt.tour <- download.tourism("data/")

## Economic data

dt.eco <- download.economy("data/")
dt.eco <- make.economy.great.again(dt.eco)

## OECD data on hours worked

dt.oecd <- get_dataset("ANHRS")
decode  <- get_decoder("data/")  

# Decoding country names

dt.oecd <- ddply(dt.oecd, ~COUNTRY + obsTime + EMPSTAT, function(xframe){
  
  xframe <<- xframe
  real.name <-  decode[decode$CODE==xframe$COUNTRY[1], "Country"]
  if(length(real.name)==0) real.name <- xframe$COUNTRY[1]
  xframe$COUNTRY <- real.name
  return(xframe)
  
})

```

```{r descriptive statistics, include=FALSE, echo=F, warning=F}
# we will save this data to the 'data folder'
summary(dt$Fatalities) ## As we can see there is a huge incident involving 1382 deaths
summary(dt$Injured)    ## The mean of injured people is higher than those that were killed. The biggest incident is involving 4000 people
dt[which(dt$Fatalities==max(dt$Fatalities, na.rm=T)), ] # The deadliest attack was the attack in Nepal in 2004
dt[which(dt$Injured==max(dt$Injured, na.rm=T)), ]       # The most injuries was caused by the attack in Kenya in 1998

sum(dt$Injured, na.rm=T) 
sum(dt$Fatalities, na.rm=T) 


## Creating a pie chart

pdf(file = "plots/Injuries and deaths pie chart.pdf", width = 15, height = 10)

pie.chart(dt$Fatalities, c(0, 1, 5, 100), cols=c("dodgerblue1", "orchid4", "gray48", "peru"), 
          title = "Fatalities")

pie.chart(dt$Injured, c(0, 1, 5, 100), cols=c("dodgerblue1", "orchid4", "gray48", "peru"), 
          title = "Injuries")
dev.off()

## Overall trend

pdf(file = "plots/daily monthly yearly casualties.pdf", width = 15, height = 10)

# excluding daily because of long calculation times

for(fr in c("monthly", "yearly")){
  data.to.plot <- aggregate.terror(dt, freq = fr)
  
  points <- cbind(data.to.plot$Injured, data.to.plot$Killed)
  
  time.span <- seq(years.to.survey[1],
                   years.to.survey[length(years.to.survey)],
                   length.out = dim(data.to.plot)[1])
  
  grid.frame(x = time.span, y = points, grid.lty = 2, grid.col = "royalblue")
  
  matplot(x= time.span, y=points, add=T, type = "o", pch=20, lwd = 2, lty = 1, cex=1, 
              col=c("firebrick3", "dodgerblue3"))
  legendary2(c("Injured", "Killed"), col=c("firebrick3", "dodgerblue3"))
  mtext(paste("Frequency is", fr), line=1, adj = 0, font = 2, cex = 1.25, col="darkslateblue")
}
dev.off()

## Graph by country

countries <- dt$Country %>% unique()

all.countries <- data.frame()

for(cn in countries){
  sub.set <- dt[dt$Country==cn, c("Country", "Injured", "Fatalities")]
  x <- c(cn,
   sum(sub.set$Injured, na.rm=T),
   sum(sub.set$Fatalities, na.rm=T)) %>% as.data.frame() %>% t()
  x[, 2:3] <- as.numeric(x[, 2:3])
  all.countries <- rbind(all.countries, x)
}

colnames(all.countries) <- c("Country", "Injuries", "Fatalities")

# Plottting according to regions

pdf(file = "plots/Injuries deaths by region.pdf", width = 20, height = 10)
for(reg in unique(regions$Region)){
  for(type in c("Injuries", "Fatalities")){
    countries <- intersect(regions[regions$Region==reg, "Country"], unique(all.countries$Country))
    data.set  <- all.countries[all.countries$Country %in% countries, c("Country", type)]
    data.set$Country <- as.character(data.set$Country)
    data.set  <- arrange(data.set, Country)
    codeID <- regions[regions$Region==reg & regions$Country %in% as.character(data.set$Country), ]
    codeID <- arrange(codeID, Country) 
    values <- data.set[, 2] %>% as.character() %>% as.numeric()
    names(values) <- codeID$CountryCode
    values <- sort(values)
    
    barplot(values, col='deepskyblue3',  horiz=T , las=1, main = paste(type, "in", reg))
  }
}
dev.off()

```

```{r data for panel model, include=FALSE, echo=F}

# In this section we will be creating a data frame for a VAR model or a panel model

master.data <- aggregate.terror.by.country(dt)

dt.tour <- rename(dt.tour, c("Year" = "Date", "CountryName" = "Country"))

master.data <- merge(master.data, dt.tour)

for(prod in unique(dt.eco$Indicator)){
  
  tmp <- dt.eco[dt.eco$Indicator==prod, c("CountryName", "Date", "value")]
  tmp <- rename(tmp, c("Year" = "Date", "CountryName" = "Country", "value" = prod))
  master.data <- merge(master.data, tmp)
  
}

# Merging with OECD data

dt.oecd <- plyr::rename(dt.oecd, c("COUNTRY" = "Country", "obsTime" = "Date", "obsValue" = "Working hours"))
dt.oecd <- dt.oecd[, c("Country", "Date", "Working hours")]

master.data <- merge(master.data, dt.oecd)

# Dropping incomplete rows

master.data <- master.data[complete.cases(master.data), ]

master.data <- arrange(master.data, Country)

```

\section{Panel data model}

Panel data provides information on individual behaviour, both across individuals and over time - the data has cross-sectional and time-series dimensions. Panel data includes N individuals over T regular time periods. We can denote the model simmilary like a typical bivariate reggression model:

$$ y_{it} = \alpha_{i} + \beta X_{it} + u_{it}   $$
The difference from a typical reggression model is that there are the $i$ and the $t$ terms, where $i$ denotes the individual and $t$ denotes the time period. The construction of a panel model starts with appropriately 'stacking' the data set. Assuming that y is the dependant variable and X is the matrix of the explanatory variables we need to have the following structure: 

$$Y = y_{i} = \begin{bmatrix}
       y_{1}    \\
       y_{2}    \\[0.3em]
       \vdots   \\[0.3em]
       y_{N}     \\[0.3em]
\end{bmatrix} = \begin{bmatrix}
       e    \\
       0    \\[0.3em]
       \vdots   \\[0.3em]
       0     \\[0.3em]
\end{bmatrix}  \alpha_{1} +  \begin{bmatrix}
       0    \\
       e    \\[0.3em]
       \vdots   \\[0.3em]
       0     \\[0.3em]
\end{bmatrix}  \alpha_{2} + \cdots + \begin{bmatrix}
       0    \\
       0    \\[0.3em]
       \vdots   \\[0.3em]
       e     \\[0.3em]
\end{bmatrix}  \alpha_{N} + \begin{bmatrix}
       x_{1}    \\[0.3em]
       x_{2}    \\[0.3em]
       \vdots   \\[0.3em]
       x_{n}     \\[0.3em]
\end{bmatrix} \beta +   \begin{bmatrix}
       u_{1}    \\[0.3em]
       u_{2}    \\[0.3em]
       \vdots   \\[0.3em]
       u_{n}     \\[0.3em]
\end{bmatrix}$$

Here

$$y_{i} = \begin{bmatrix}
       y_{i1}    \\
       y_{i2}    \\[0.3em]
       \vdots   \\[0.3em]
       y_{iT}     \\[0.3em]
\end{bmatrix}

x_{i} = \begin{bmatrix}
       x_{1i1} & x_{2i1} & \cdots & x_{Ki1}    \\
       x_{1i2} & x_{2i2} & \cdots & x_{Ki2}   \\[0.3em]
       \vdots & \vdots & \cdots & \vdots   \\[0.3em]
      x_{1iT} & x_{2iT} & \cdots & x_{KiT}      \\[0.3em]
\end{bmatrix}$$  

```{r panel model, include=FALSE, echo=F}

# In this section we will be creating a data frame for a VAR model or a panel model

model <- plm(formula = Total.Arrivals ~ Terror.attacks, data=master.data, index=c("Country"))
```










